name: ğŸš€ TCA-InfraForge Development Platform
on:
  workflow_dispatch:
    inputs:
      platform_mode:
        description: 'Platform Deployment Mode'
        required: false
        default: 'development'
        type: choice
        options:
        - 'development'
        - 'full-enterprise'
        - 'demo-only'
      duration_minutes:
        description: 'Platform Duration (minutes, 0 = permanent)'
        required: false
        default: '120'
        type: choice
        options:
        - '30'
        - '60' 
        - '120'
        - '240'
        - '0'

env:
  CLUSTER_NAME: tca-infraforge-demo
  ARGOCD_VERSION: v2.8.4

jobs:
  deploy-demo:
    name: ğŸ¬ Deploy GitOps Demo
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
    - name: ğŸ“‹ Checkout TCA-InfraForge
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.5.0
        
    - name: âš™ï¸ Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'
        
    - name: ğŸ³ Setup Docker
      run: |
        docker --version
        docker info
        
    - name: ğŸ—ï¸ Initialize TCA Infrastructure
      working-directory: ./terraform
      run: |
        echo "ğŸš€ Initializing TCA-InfraForge Infrastructure..."
        terraform init
        
    - name: ğŸ“Š Plan Infrastructure
      working-directory: ./terraform
      run: |
        echo "ğŸ“‹ Planning TCA-InfraForge deployment..."
        terraform plan -var="cluster_name=${{ env.CLUSTER_NAME }}"
        
    - name: ğŸš€ Deploy Infrastructure
      working-directory: ./terraform
      run: |
        echo "ğŸ¯ Deploying TCA-InfraForge demo cluster..."
        terraform apply -auto-approve -var="cluster_name=${{ env.CLUSTER_NAME }}"
        
    - name: â³ Wait for Cluster Ready
      run: |
        echo "â³ Waiting for cluster to be ready..."
        kubectl wait --for=condition=Ready nodes --all --timeout=300s
        kubectl get nodes -o wide
        
    - name: ğŸ“¦ Verify ArgoCD Installation
      run: |
        echo "ğŸ” Verifying ArgoCD installation..."
        kubectl get pods -n argocd
        kubectl wait --for=condition=available --timeout=600s deployment/argocd-server -n argocd
        
    - name: ğŸ”‘ Get ArgoCD Access Info
      id: argocd-info
      run: |
        echo "ğŸ”‘ Getting ArgoCD access information..."
        
        # Get admin password
        ARGOCD_PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
        echo "argocd_password=$ARGOCD_PASSWORD" >> $GITHUB_OUTPUT
        
        echo "âœ… ArgoCD accessible via NodePort - no port-forwarding needed"
        
    - name: ğŸ¯ Deploy TCA Applications
      run: |
        echo "ğŸ¯ Deploying TCA-InfraForge sample applications..."
        kubectl apply -f argocd/applications/
        
        # Wait for applications to sync
        sleep 30
        kubectl get applications -n argocd
        
    - name: ğŸ“Š Demo Summary
      run: |
        echo "
        ğŸ‰ TCA-InfraForge Demo Successfully Deployed!
        
        ğŸ“‹ Cluster Information:
        $(kubectl get nodes -o wide)
        
        ğŸš€ ArgoCD Applications:
        $(kubectl get applications -n argocd)
        
        ğŸ”— Access Information (All via Traefik Ingress):
        - ArgoCD URL: http://localhost:8070/argocd
        - Grafana URL: http://localhost:8070/grafana (admin/tca-demo-password)
        - Traefik Dashboard: http://localhost:8070/dashboard
        - ArgoCD Username: admin
        - ArgoCD Password: ${{ steps.argocd-info.outputs.argocd_password }}
        
        â° Platform will run for ${{ github.event.inputs.duration_minutes || '120' }} minutes
        
        ğŸ‘¨â€ğŸ’» Built by: Temitayo Charles Akinniranye
        ğŸ—ï¸ Project: TCA-InfraForge GitOps Portfolio
        "
        
    - name: â±ï¸ Keep Demo Running
      run: |
        DURATION_MINUTES=${{ github.event.inputs.duration_minutes || '120' }}
        DURATION_SECONDS=$((DURATION_MINUTES * 60))
        
        echo "â±ï¸ Keeping demo alive for $DURATION_MINUTES minutes..."
        echo "ğŸŒ All services accessible via Traefik at http://localhost:8070/*"
        echo "ğŸ‘€ Use this time to explore the GitOps workflow!"
        
        # Keep the demo running
        sleep $DURATION_SECONDS
        
    - name: ğŸ§¹ Cleanup Demo Environment
      if: always()
      working-directory: ./terraform
      run: |
        echo "ğŸ§¹ Cleaning up TCA-InfraForge demo environment..."
        
        # Destroy infrastructure
        terraform destroy -auto-approve -var="cluster_name=${{ env.CLUSTER_NAME }}" || true
        
        echo "âœ… TCA-InfraForge demo cleanup completed!"